{% extends "base.html" %}

{% block title %}AI Coach - LifeCurriculum{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="chatManager()" x-init="init()">
    <!-- Vibe Check Banner -->
    <div x-show="!vibeChecked" class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl px-6 py-4 mb-6">
        <div class="text-center mb-3">
            <h3 class="text-sm font-semibold text-gray-700">How are you feeling right now?</h3>
            <p class="text-xs text-gray-500">This helps personalize your coaching session</p>
        </div>
        <div class="flex justify-center gap-2 flex-wrap">
            <button @click="setMood('overwhelmed')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'overwhelmed'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Overwhelmed</button>
            <button @click="setMood('frustrated')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'frustrated'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Frustrated</button>
            <button @click="setMood('tired')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'tired'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Tired</button>
            <button @click="setMood('okay')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'okay'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Okay</button>
            <button @click="setMood('hopeful')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'hopeful'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Hopeful</button>
            <button @click="setMood('happy')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'happy'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Happy</button>
            <button @click="setMood('excited')" :class="{'ring-2 ring-purple-500 bg-purple-100': currentMood === 'excited'}" class="px-3 py-2 bg-white rounded-full border border-gray-200 text-sm hover:shadow-md transition-all">Excited</button>
        </div>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Family Coach</h1>
            <p class="text-gray-600 mt-1">AI-powered guidance for mindful parenting</p>
        </div>
        <div x-show="vibeChecked" class="flex items-center gap-2 text-sm bg-purple-100 px-3 py-1 rounded-full">
            <span class="text-gray-600">Mood:</span>
            <span x-text="getMoodEmoji()"></span>
            <button @click="vibeChecked = false" class="text-purple-600 hover:text-purple-800 ml-1">change</button>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <!-- Chat Messages -->
        <div class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50" x-ref="messagesContainer">
            <!-- Welcome Message -->
            <div x-show="messages.length === 0 && !sessionStarted" class="text-center py-8">
                <div class="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Welcome to Your Family Coach</h3>
                <p class="text-gray-600 mb-6">I'm here to support your parenting journey with personalized guidance powered by Claude AI.</p>
                <button
                    @click="startSession()"
                    :disabled="starting"
                    class="px-6 py-3 bg-gradient-to-r from-orange-500 to-pink-500 text-white rounded-xl font-medium hover:from-orange-600 hover:to-pink-600 transition-all shadow-md disabled:opacity-50"
                >
                    <span x-show="!starting">Start Coaching Session</span>
                    <span x-show="starting" class="flex items-center">
                        <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Starting...
                    </span>
                </button>
            </div>

            <!-- Messages -->
            <template x-for="(msg, index) in messages" :key="index">
                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.role === 'user' ? 'bg-gradient-to-r from-orange-500 to-pink-500 text-white' : 'bg-white text-gray-800 border border-gray-100'" class="rounded-2xl px-4 py-3 max-w-[80%] shadow-sm">
                        <p class="whitespace-pre-wrap" x-text="msg.content"></p>
                    </div>
                </div>
            </template>

            <!-- Streaming Response -->
            <div x-show="streaming" x-cloak class="flex justify-start">
                <div class="bg-white text-gray-800 border border-gray-100 rounded-2xl px-4 py-3 max-w-[80%] shadow-sm">
                    <p class="whitespace-pre-wrap" x-ref="streamingContent"></p>
                    <span class="inline-block w-2 h-4 bg-orange-500 animate-pulse ml-1"></span>
                </div>
            </div>

            <!-- Error Message -->
            <div x-show="error" x-cloak class="text-center py-4">
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 max-w-md mx-auto">
                    <p class="text-red-600 text-sm" x-text="error"></p>
                    <button @click="error = ''" class="mt-2 text-red-500 hover:text-red-700 text-sm underline">Dismiss</button>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="border-t p-4 bg-white" x-show="sessionStarted">
            <form @submit.prevent="sendMessage()">
                <div class="flex gap-3">
                    <textarea
                        x-model="message"
                        x-ref="input"
                        @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                        placeholder="Share your thoughts, ask questions, or describe a parenting challenge..."
                        class="flex-1 resize-none border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        rows="2"
                        :disabled="sending"
                    ></textarea>
                    <button
                        type="submit"
                        :disabled="!message.trim() || sending"
                        class="bg-gradient-to-r from-orange-500 to-pink-500 text-white px-6 py-3 rounded-xl font-medium hover:from-orange-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                    >
                        <span x-show="!sending">Send</span>
                        <span x-show="sending" x-cloak class="flex items-center">
                            <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-400 mt-2 text-center">
                Press Enter to send, Shift+Enter for new line
            </p>
        </div>
    </div>

    <!-- Powered by Claude -->
    <div class="mt-4 text-center">
        <p class="text-xs text-gray-400">Powered by Claude AI from Anthropic</p>
    </div>
</div>

<script>
function chatManager() {
    return {
        // Chat state
        message: '',
        messages: [],
        sending: false,
        streaming: false,
        sessionStarted: false,
        sessionId: null,
        starting: false,
        error: '',

        // Vibe check
        vibeChecked: false,
        currentMood: '',

        moodEmojis: {
            'overwhelmed': 'Overwhelmed',
            'frustrated': 'Frustrated',
            'tired': 'Tired',
            'okay': 'Okay',
            'hopeful': 'Hopeful',
            'happy': 'Happy',
            'excited': 'Excited'
        },

        init() {
            // Check for existing session in localStorage
            const savedSession = localStorage.getItem('currentChatSession');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    // Only restore if session is less than 1 hour old
                    if (Date.now() - session.timestamp < 3600000) {
                        this.sessionId = session.id;
                        this.sessionStarted = true;
                        this.loadSessionMessages();
                    } else {
                        localStorage.removeItem('currentChatSession');
                    }
                } catch (e) {
                    localStorage.removeItem('currentChatSession');
                }
            }
        },

        setMood(mood) {
            this.currentMood = mood;
            this.vibeChecked = true;
        },

        getMoodEmoji() {
            return this.moodEmojis[this.currentMood] || 'Neutral';
        },

        async startSession() {
            this.starting = true;
            this.error = '';

            try {
                const response = await fetch('/api/chat/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Coaching Session - ' + new Date().toLocaleDateString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start session. Please try again.');
                }

                const session = await response.json();
                this.sessionId = session.id;
                this.sessionStarted = true;
                this.messages = [];

                // Save session to localStorage
                localStorage.setItem('currentChatSession', JSON.stringify({
                    id: session.id,
                    timestamp: Date.now()
                }));

                // Focus the input so user can start typing immediately
                this.$nextTick(() => {
                    if (this.$refs.input) this.$refs.input.focus();
                });

            } catch (e) {
                this.error = e.message || 'Failed to start session. Please try again.';
            } finally {
                this.starting = false;
            }
        },

        async loadSessionMessages() {
            try {
                const response = await fetch(`/api/chat/sessions/${this.sessionId}`);
                if (response.ok) {
                    const session = await response.json();
                    this.messages = session.messages.map(m => ({
                        role: m.role,
                        content: m.content
                    }));
                    this.scrollToBottom();
                } else if (response.status === 404) {
                    // Session no longer exists, clear and reset
                    console.log('Session expired, creating new session');
                    localStorage.removeItem('currentChatSession');
                    this.sessionId = null;
                    this.sessionStarted = false;
                    this.messages = [];
                }
            } catch (e) {
                console.error('Failed to load session messages');
                // Clear stale session on error
                localStorage.removeItem('currentChatSession');
                this.sessionId = null;
                this.sessionStarted = false;
            }
        },

        async sendMessage() {
            if (!this.message.trim() || this.sending) return;

            const userMessage = this.message;
            this.message = '';
            this.sending = true;
            this.streaming = true;
            this.error = '';

            // Add user message to UI
            this.messages.push({ role: 'user', content: userMessage });
            this.scrollToBottom();

            // Clear streaming content
            this.$refs.streamingContent.textContent = '';

            try {
                const response = await fetch(`/api/chat/sessions/${this.sessionId}/message?stream=true`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: userMessage,
                        mood: this.currentMood || null
                    })
                });

                if (response.status === 404) {
                    // Session expired, need to start fresh
                    this.error = 'Session expired. Please start a new coaching session.';
                    this.streaming = false;
                    localStorage.removeItem('currentChatSession');
                    this.sessionId = null;
                    this.sessionStarted = false;
                    this.messages = [];
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to send message');
                }

                await this.handleStreamResponse(response);
            } catch (e) {
                this.error = 'Failed to send message. Please try again.';
                this.streaming = false;
            }

            this.sending = false;
            this.$nextTick(() => {
                if (this.$refs.input) this.$refs.input.focus();
            });
        },

        async handleStreamResponse(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const data = line.slice(5).trim();
                            if (data === '') continue;

                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content) {
                                    fullResponse += parsed.content;
                                    if (this.$refs.streamingContent) {
                                        this.$refs.streamingContent.textContent = fullResponse;
                                    }
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        } else if (line.startsWith('event: done')) {
                            // Stream complete
                            this.streaming = false;
                            this.messages.push({ role: 'assistant', content: fullResponse });
                        }
                    }
                }
            } finally {
                this.streaming = false;
            }
        },

        scrollToBottom() {
            this.$nextTick(() => {
                if (this.$refs.messagesContainer) {
                    this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
                }
            });
        },

        resetSession() {
            localStorage.removeItem('currentChatSession');
            this.sessionStarted = false;
            this.sessionId = null;
            this.messages = [];
            this.message = '';
        }
    };
}
</script>
{% endblock %}
