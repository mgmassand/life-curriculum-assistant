{% extends "base.html" %}

{% block title %}{{ stage.name }} - Curriculum{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="progressTracker()">
    <!-- Header -->
    <div class="mb-6">
        <a href="/curriculum" class="text-indigo-600 hover:text-indigo-700 text-sm mb-2 inline-block">&larr; All Age Stages</a>
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ stage.name }}</h1>
                <p class="mt-1 text-gray-600">{{ stage.description }}</p>
            </div>
            {% if selected_child %}
            <div class="text-right">
                <div class="text-sm text-gray-500">Tracking for</div>
                <div class="font-medium text-gray-900">{{ selected_child.name }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Child Selector (if children exist) -->
    {% if children %}
    <div class="mb-6 bg-white rounded-lg shadow p-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Track progress for:</label>
        <div class="flex flex-wrap gap-2">
            {% for child in children %}
            <a href="/curriculum/{{ stage.slug }}?child={{ child.id }}{% if selected_domain %}&domain={{ selected_domain }}{% endif %}"
               class="px-4 py-2 rounded-full text-sm font-medium transition-colors
                      {% if selected_child and selected_child.id == child.id %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                {{ child.name }}
            </a>
            {% endfor %}
            <a href="/curriculum/{{ stage.slug }}{% if selected_domain %}?domain={{ selected_domain }}{% endif %}"
               class="px-4 py-2 rounded-full text-sm font-medium transition-colors
                      {% if not selected_child %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                Browse Only
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Domain Filter -->
    <div class="mb-6 flex flex-wrap gap-2">
        <a href="/curriculum/{{ stage.slug }}{% if selected_child %}?child={{ selected_child.id }}{% endif %}"
           class="px-4 py-2 rounded-full text-sm font-medium transition-colors
                  {% if not selected_domain %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
            All Domains
        </a>
        {% for domain in domains %}
        <a href="/curriculum/{{ stage.slug }}?domain={{ domain.slug }}{% if selected_child %}&child={{ selected_child.id }}{% endif %}"
           class="px-4 py-2 rounded-full text-sm font-medium transition-colors
                  {% if selected_domain == domain.slug %}text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}"
           style="{% if selected_domain == domain.slug %}background-color: {{ domain.color }}{% endif %}">
            {{ domain.name }}
        </a>
        {% endfor %}
    </div>

    <!-- Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Milestones -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="mr-2">ðŸŽ¯</span> Milestones
                <span class="ml-2 text-sm font-normal text-gray-500">({{ milestones|length }})</span>
            </h2>
            <div class="space-y-4">
                {% for milestone in milestones %}
                <div class="bg-white rounded-lg shadow p-4" x-data="{ showNotes: false }">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ milestone.title }}</h3>
                            <p class="text-sm text-gray-600 mt-1">{{ milestone.description }}</p>
                        </div>
                        {% if milestone.importance == 'critical' %}
                        <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">Critical</span>
                        {% elif milestone.importance == 'important' %}
                        <span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">Important</span>
                        {% endif %}
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 rounded text-xs" style="background-color: {{ milestone.domain.color }}20; color: {{ milestone.domain.color }}">
                                {{ milestone.domain.name }}
                            </span>
                            {% if milestone.typical_age_months %}
                            <span class="text-gray-500 text-sm">~{{ milestone.typical_age_months }} months</span>
                            {% endif %}
                        </div>
                        {% if selected_child %}
                        <div class="flex items-center gap-2">
                            {% set progress = child_progress.get(milestone.id|string) %}
                            {% if progress and progress.status == 'completed' %}
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Completed</span>
                            {% else %}
                            <button @click.stop="markComplete('milestone', '{{ milestone.id }}', '{{ milestone.title }}')"
                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded-full hover:bg-green-700 transition-colors">
                                Mark Complete
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 italic">No milestones found for this filter.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Activities -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <span class="mr-2">ðŸ“š</span> Activities
                <span class="ml-2 text-sm font-normal text-gray-500">({{ activities|length }})</span>
            </h2>
            <div class="space-y-4">
                {% for activity in activities %}
                <div class="bg-white rounded-lg shadow p-4"
                     x-data="{ expanded: false }">
                    <div class="cursor-pointer" @click="expanded = !expanded">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="font-medium text-gray-900">{{ activity.title }}</h3>
                                <p class="text-sm text-gray-600 mt-1">{{ activity.description }}</p>
                            </div>
                            <svg x-show="!expanded" class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            <svg x-show="expanded" x-cloak class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                        </div>

                        <div class="mt-3 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded text-xs" style="background-color: {{ activity.domain.color }}20; color: {{ activity.domain.color }}">
                                    {{ activity.domain.name }}
                                </span>
                                {% if activity.duration_minutes %}
                                <span class="text-gray-500 text-sm">{{ activity.duration_minutes }} min</span>
                                {% endif %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">{{ activity.difficulty }}</span>
                            </div>
                            {% if selected_child %}
                            <div class="flex items-center gap-2" @click.stop>
                                {% set progress = child_progress.get(activity.id|string) %}
                                {% if progress and progress.status == 'completed' %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Completed</span>
                                {% else %}
                                <button @click="markComplete('activity', '{{ activity.id }}', '{{ activity.title }}')"
                                        class="px-3 py-1 bg-green-600 text-white text-xs rounded-full hover:bg-green-700 transition-colors">
                                    Mark Complete
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Expanded Content -->
                    <div x-show="expanded" x-cloak class="mt-4 pt-4 border-t border-gray-100">
                        <h4 class="font-medium text-gray-900 mb-2">Instructions:</h4>
                        <p class="text-sm text-gray-600 whitespace-pre-line">{{ activity.instructions }}</p>

                        {% if activity.materials_needed %}
                        <h4 class="font-medium text-gray-900 mt-4 mb-2">Materials Needed:</h4>
                        <ul class="text-sm text-gray-600 list-disc list-inside">
                            {% for material in activity.materials_needed %}
                            <li>{{ material }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 italic">No activities found for this filter.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showModal = false">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Record Progress</h3>
                <p class="text-gray-600 mb-4" x-text="modalTitle"></p>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                    <textarea x-model="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="How did it go? Any observations?"></textarea>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rating (optional)</label>
                    <div class="flex gap-2">
                        <template x-for="i in 5">
                            <button @click="rating = i" :class="rating >= i ? 'text-yellow-400' : 'text-gray-300'" class="text-2xl focus:outline-none">â˜…</button>
                        </template>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="showModal = false" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-500">Cancel</button>
                    <button @click="submitProgress()" :disabled="saving" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50">
                        <span x-show="!saving">Save Progress</span>
                        <span x-show="saving" x-cloak>Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function progressTracker() {
    return {
        showModal: false,
        modalTitle: '',
        modalType: '',
        modalId: '',
        notes: '',
        rating: 0,
        saving: false,
        childId: '{{ selected_child.id if selected_child else "" }}',

        markComplete(type, id, title) {
            if (!this.childId) {
                alert('Please select a child to track progress');
                return;
            }
            this.modalType = type;
            this.modalId = id;
            this.modalTitle = title;
            this.notes = '';
            this.rating = 0;
            this.showModal = true;
        },

        async submitProgress() {
            this.saving = true;
            try {
                const payload = {
                    child_id: this.childId,
                    status: 'completed',
                    notes: this.notes || null,
                    rating: this.rating || null,
                };

                if (this.modalType === 'milestone') {
                    payload.milestone_id = this.modalId;
                } else {
                    payload.activity_id = this.modalId;
                }

                const response = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    this.showModal = false;
                    // Reload page to show updated progress
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to save progress');
                }
            } catch (e) {
                alert('Network error. Please try again.');
            }
            this.saving = false;
        }
    }
}
</script>
{% endblock %}
